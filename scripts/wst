import c from"node:fs";import o from"node:path";import{execSync as n}from"node:child_process";import a from"node:readline";var t="[0m",e="[1m",r="[2m",s="[31m",i="[32m",l="[33m",p="[36m",u=function(){return u=Object.assign||function(c){for(var o,n=1,a=arguments.length;n<a;n++)for(var t in o=arguments[n])Object.prototype.hasOwnProperty.call(o,t)&&(c[t]=o[t]);return c},u.apply(this,arguments)};function f(n){void 0===n&&(n=["packages/*"]);for(var a=process.cwd(),t=o.parse(a).root;!n.some((function(n){return c.existsSync(o.join(a,n.replace(/\*/g,"")))}))&&a!==t;)a=o.dirname(a);return a!==t?a:process.cwd()}"function"==typeof SuppressedError&&SuppressedError;var g={packageManager:"npm",workspacesDirs:["packages/*"]};var m=function(){var n=f(g.workspacesDirs),a=o.join(n,"workspace.json"),e=g;if(c.existsSync(a))try{var r=JSON.parse(c.readFileSync(a,"utf-8"));e=u(u({},e),r)}catch(c){console.error("".concat(s,"Error reading config file: ").concat(c.message).concat(t))}return e}();function h(n,a){var t=n.split(o.sep),e=t[0],r=t.slice(1).join(o.sep),s=[];return c.readdirSync(a,{withFileTypes:!0}).forEach((function(c){if(c.isDirectory()&&function(c,o){return"*"===c||c===o}(e,c.name)){var n=o.join(a,c.name);r?s=s.concat(h(r,n)):s.push(n)}})),s}var d=JSON.parse(c.readFileSync(o.join(f(m.workspacesDirs),"package.json"),"utf-8"));function v(){var n=f(m.workspacesDirs),a=[];return m.workspacesDirs.forEach((function(t){h(t,n).forEach((function(n){if(c.existsSync(n)&&c.lstatSync(n).isDirectory()){var t=o.join(n,"package.json");if(c.existsSync(t)){var e=JSON.parse(c.readFileSync(t,"utf-8"));a.push({name:e.name||o.basename(n),path:n})}}}))})),a}function k(n){var a=o.join(n,"package.json");return c.existsSync(a)&&JSON.parse(c.readFileSync(a,"utf-8")).scripts||{}}function w(){v().forEach((function(c){var o=c.name,n=k(c.path);console.log("".concat(r,"â€” workspace:").concat(t).concat(e).concat(p).concat(o).concat(t)),Object.keys(n).length>0?Object.entries(n).forEach((function(c){var o=c[0],n=c[1];console.log("".concat(r,"> ").concat(t).concat(i).concat(o).concat(t).concat(r,": ").concat(n).concat(t))})):console.log("".concat(l,"â”€ No scripts found.").concat(t)),console.log()}))}function y(c){var o=v(),n=[];return o.forEach((function(o){var a=o.name,t=k(o.path);Object.entries(t).forEach((function(o){var t=o[0],e=o[1];(t.includes(c)||e.includes(c))&&n.push({workspace:a,name:t,command:e})}))})),n}function S(c){0!==c.length?(console.log("".concat(e,"Search results:").concat(t,"\n")),c.forEach((function(c){var o=c.workspace,n=c.name,a=c.command;console.log("".concat(p).concat(o).concat(t," > ").concat(i).concat(n).concat(t)),console.log("".concat(r,"  ").concat(a).concat(t,"\n"))}))):console.log("".concat(l,"No matching scripts found.").concat(t))}function j(c,o){var a=function(c,o,n){switch(c.toLowerCase()){case"npm":return"npm run ".concat(n," --workspace=").concat(o);case"yarn":return"yarn workspace ".concat(o," run ").concat(n);case"pnpm":return"pnpm --filter ".concat(o," run ").concat(n);default:return console.warn("".concat(l,'Warning: Unknown package manager "').concat(c,'". Defaulting to npm.').concat(t)),"npm run ".concat(n," --workspace=").concat(o)}}(m.packageManager,c,o),e=process.hrtime();console.log("".concat(r,"> ").concat(a).concat(t));try{if(n(a,{stdio:"inherit"}),"npm"===m.packageManager||"pnpm"===m.packageManager){var p=process.hrtime(e),u=(1e3*p[0]+p[1]/1e6).toFixed(2);console.log("".concat(i,"Done in ").concat(u,"ms").concat(t))}}catch(c){console.error("".concat(s,"Error executing script: ").concat(c.message).concat(t))}}!function(){var c,o=process.argv,n=o[2],i=o.slice(3),u="".concat(t).concat(r,"  ").concat("wst").concat(t).concat(l).concat(e),f="".concat(r).concat(t).concat(p).concat(e).concat(d.name).concat(t," ").concat(r,"v").concat(d.version).concat(t);if(console.log(f),void 0===n)console.log("\n".concat(r,"Usage:").concat(t)),console.log("".concat(u," list").concat(t).concat(r," # List all scripts from all workspaces").concat(t)),console.log("".concat(u," run <workspace> <script>").concat(t).concat(r," # Run a specific script from a workspace").concat(t)),console.log("".concat(u," search <term>").concat(t).concat(r," # Search for a script by name or content").concat(t)),console.log("".concat(u," interactive").concat(t).concat(r," # Start interactive mode").concat(t)),console.log("\n".concat(t).concat(r,"Examples:").concat(t)),console.log("".concat(u," list")),console.log("".concat(u," run core build")),console.log("".concat(u," search test")),console.log("".concat(u," interactive"));else if("list"===n)w();else if("run"===n&&i.length>=2){j(i[0],i[1])}else if("search"===n&&i.length>0){S(y(i.join(" ")))}else"interactive"===n?(c=a.createInterface({input:process.stdin,output:process.stdout}),console.log("".concat(e,"Interactive Mode").concat(t)),console.log("Type 'exit' to quit, 'list' to show all scripts, or 'search <term>' to search scripts."),c.prompt(),c.on("line",(function(o){var n=o.trim().split(" "),a=n[0],e=n.slice(1);switch(a.toLowerCase()){case"exit":c.close();break;case"list":w();break;case"search":e.length>0?S(y(e.join(" "))):console.log("".concat(l,"Please provide a search term.").concat(t));break;case"run":e.length>=2?j(e[0],e[1]):console.log("".concat(l,"Please provide both workspace and script name.").concat(t));break;default:console.log("".concat(l,"Unknown command. Try 'list', 'search', 'run', or 'exit'.").concat(t))}c.prompt()})).on("close",(function(){console.log("".concat(e,"Goodbye!").concat(t)),process.exit(0)}))):console.log("".concat(s,"Invalid command or missing arguments. Use without arguments to see usage.").concat(t))}();
